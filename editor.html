<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design Monster Studio ‚Äî Editor</title>
    <link rel="stylesheet" href="styles/premium.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .studio-page {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .studio-header {
            padding: 1.5rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .studio-main {
            flex: 1;
            padding: 0 2.5rem 2.5rem;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .chip-premium {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .chip-premium:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(34, 211, 238, 0.05);
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
        }
    </style>
</head>

<body class="studio-page">
    <div class="mesh-bg"></div>

    <header class="studio-header">
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="4" width="20" height="16" rx="3" stroke="currentColor" stroke-width="2.5" />
            </svg>
            STUDIO <span>EDITOR</span>
        </div>
        <a href="index.html" class="btn-secondary" style="text-decoration: none;">‚Üê Exit Studio</a>
    </header>

    <div class="studio-main">
        <div class="studio-layout">
            <!-- STAGE -->
            <div class="preview-stage">
                <iframe id="previewFrame"></iframe>
            </div>

            <!-- SIDEBAR -->
            <div class="studio-sidebar">
                <!-- AI CO-PILOT -->
                <div class="glass-panel" style="padding: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1rem;">
                        <span class="ai-pill">Neural Link</span>
                        <h3 style="font-family: 'Outfit'; font-size: 1.1rem;">AI Architect</h3>
                    </div>

                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1.5rem;">
                        Command the engine to restructure, re-style, or inject new DNA.
                    </p>

                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;"
                        id="suggestionChips">
                        <span class="chip-premium" data-prompt="Change the font to premium serif like Playfair">Elegant
                            Font</span>
                        <span class="chip-premium" data-prompt="Add floaty kinetic particles to the background">Add
                            Kinetic</span>
                        <span class="chip-premium" data-prompt="Transform into a futuristic dark mode">Cyber Mode</span>
                        <span class="chip-premium" data-prompt="Make all headings much larger and bolder">Big
                            Headlines</span>
                    </div>

                    <div style="position: relative;">
                        <textarea id="aiPromptInput"
                            style="height: 48px; padding: 12px 60px 12px 15px; font-size: 0.9rem;"
                            placeholder="Type command..."></textarea>
                        <button id="aiSendBtn"
                            style="position: absolute; right: 8px; top: 8px; background: var(--accent); color: #000; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>

                    <div class="history-list" id="editHistory"></div>
                </div>

                <!-- EXPORT HUB -->
                <div class="glass-panel" style="padding: 2rem;">
                    <div class="panel-title" style="margin-bottom: 1.5rem; font-size: 0.85rem;">Transmission Hub</div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-bottom: 1rem;">
                        <button class="btn-secondary" id="openPreviewBtn"
                            style="padding: 0.6rem; font-size: 0.75rem;">PREVIEW</button>
                        <button class="btn-secondary" id="downloadHtmlBtn"
                            style="padding: 0.6rem; font-size: 0.75rem;">HTML</button>
                        <button class="btn-secondary" id="downloadPdfBtn"
                            style="padding: 0.6rem; font-size: 0.75rem;">PDF</button>
                        <button class="btn-secondary" id="downloadPngBtn"
                            style="padding: 0.6rem; font-size: 0.75rem;">IMAGE</button>
                    </div>

                    <button class="btn-premium" id="exportCanvaBtn"
                        style="width: 100%; background: #00c4cc; color: #fff; box-shadow: none; font-size: 0.8rem; padding: 0.8rem;">
                        <span>Export to Canva</span>
                    </button>
                    <div style="height: 0.5rem;"></div>
                    <button class="btn-premium" id="exportFigmaBtn"
                        style="width: 100%; background: #f24e1e; color: #fff; box-shadow: none; font-size: 0.8rem; padding: 0.8rem;">
                        <span>Push to Figma</span>
                    </button>
                </div>

                <!-- SOURCE CODE -->
                <div class="glass-panel" style="padding: 1.5rem; flex: 1; display: flex; flex-direction: column;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div class="panel-title" style="margin: 0; font-size: 0.85rem;">DNA Stream</div>
                        <button class="tab-btn" id="toggleCodeBtn">Hide</button>
                    </div>
                    <textarea id="codeEditor"
                        style="flex: 1; background: #000; border: none; font-family: 'DM Mono', monospace; font-size: 0.75rem; color: #22d3ee;"></textarea>
                    <button class="btn-secondary" id="updatePreviewBtn"
                        style="margin-top: 1rem; width: 100%; font-size: 0.8rem;">‚Üª Re-compile Stream</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="premium-toast" id="toast"></div>

    <script type="module">
        import { exportToCanva } from './scripts/export/canva.js';
        import { exportToFigma } from './scripts/export/figma.js';

        // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
        const generatedHTML = sessionStorage.getItem('LAST_GENERATED_PRESENTATION');
        let currentHtml = generatedHTML || '<h1>No presentation found</h1>';
        let htmlHistory = [currentHtml];
        let historyIndex = 0;

        // ‚îÄ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ
        const previewFrame = document.getElementById('previewFrame');
        const codeEditor = document.getElementById('codeEditor');
        const aiPromptInput = document.getElementById('aiPromptInput');
        const aiSendBtn = document.getElementById('aiSendBtn');
        const editHistory = document.getElementById('editHistory');
        const toast = document.getElementById('toast');
        const outlineData = safeJsonParse(sessionStorage.getItem('LAST_OUTLINE')) || { slides: [] };
        const generationWarning = sessionStorage.getItem('LAST_GENERATION_WARNING') || '';

        function updatePreview(html) {
            previewFrame.srcdoc = html;
            codeEditor.value = html;
            currentHtml = html;
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function safeJsonParse(value) {
            if (!value) return null;
            try { return JSON.parse(value); } catch { return null; }
        }

        // --- Init ---
        if (!generatedHTML) window.location.href = 'index.html';
        else updatePreview(currentHtml);
        if (generationWarning) {
            setTimeout(() => showToast(generationWarning), 450);
        }

        // --- AI Edit ---
        async function performAIEdit(instruction) {
            if (!instruction) return;
            const apiKey = localStorage.getItem('GEMINI_API_KEY');
            if (!apiKey) {
                showToast('üîë Studio Key Required');
                return;
            }

            aiSendBtn.style.opacity = '0.5';
            aiSendBtn.disabled = true;

            try {
                const response = await fetch('/api/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentHtml, instruction, apiKey })
                });
                const data = await response.json();
                if (!response.ok) {
                    showToast(data.error || 'Transmission Error');
                    return;
                }
                if (data.html) {
                    htmlHistory.push(data.html);
                    historyIndex++;
                    updatePreview(data.html);
                    showToast('Neural Edit Applied');

                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const text = document.createElement('span');
                    text.textContent = `‚úì ${instruction.substring(0, 30)}...`;
                    item.appendChild(text);
                    editHistory.prepend(item);
                    aiPromptInput.value = '';
                }
            } catch (err) { showToast('Transmission Error'); }
            finally { aiSendBtn.style.opacity = '1'; aiSendBtn.disabled = false; }
        }

        aiSendBtn.onclick = () => performAIEdit(aiPromptInput.value);
        aiPromptInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                performAIEdit(aiPromptInput.value);
            }
        };

        // Chips
        document.querySelectorAll('.chip-premium').forEach(c => {
            c.onclick = () => performAIEdit(c.dataset.prompt);
        });

        // Direct code edit
        document.getElementById('updatePreviewBtn').onclick = () => {
            updatePreview(codeEditor.value);
            showToast('Local Compilation Success');
        };

        // Download
        document.getElementById('downloadHtmlBtn').onclick = () => {
            const blob = new Blob([currentHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'presentation.html'; a.click();
        };
        document.getElementById('openPreviewBtn').onclick = () => {
            const blob = new Blob([currentHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank', 'noopener,noreferrer');
            setTimeout(() => URL.revokeObjectURL(url), 10000);
        };

        // Canva/Figma placeholders
        document.getElementById('exportCanvaBtn').onclick = async () => {
            try {
                let accessToken = localStorage.getItem('CANVA_ACCESS_TOKEN');
                if (!accessToken) {
                    accessToken = window.prompt('Enter Canva access token');
                }
                if (!accessToken) {
                    showToast('Canva token required');
                    return;
                }
                localStorage.setItem('CANVA_ACCESS_TOKEN', accessToken);

                showToast('Simulating Canva Export...');
                const result = await exportToCanva(outlineData, { accessToken });
                if (result?.designUrl) {
                    window.open(result.designUrl, '_blank', 'noopener,noreferrer');
                }
                showToast(result?.message || 'Canva export complete');
            } catch (err) {
                showToast(err?.message || 'Canva export failed');
            }
        };
        document.getElementById('exportFigmaBtn').onclick = async () => {
            try {
                let personalAccessToken = localStorage.getItem('FIGMA_PAT');
                if (!personalAccessToken) {
                    personalAccessToken = window.prompt('Enter Figma PAT');
                }
                if (!personalAccessToken) {
                    showToast('Figma PAT required');
                    return;
                }

                let fileId = localStorage.getItem('FIGMA_FILE_ID');
                if (!fileId) {
                    fileId = window.prompt('Enter Figma file ID');
                }
                if (!fileId) {
                    showToast('Figma file ID required');
                    return;
                }

                localStorage.setItem('FIGMA_PAT', personalAccessToken);
                localStorage.setItem('FIGMA_FILE_ID', fileId);

                showToast('Simulating Figma Push...');
                const result = await exportToFigma(outlineData, { personalAccessToken }, fileId);
                showToast(result?.message || 'Figma export complete');
            } catch (err) {
                showToast(err?.message || 'Figma export failed');
            }
        };
    </script>
</body>

</html>
